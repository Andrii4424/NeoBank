name: CI/CD - Master

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  backend:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test
        run: dotnet test -c Release --verbosity normal

  frontend:
    name: Frontend - Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          cd src/Client
          npm ci

      - name: Lint (optional)
        run: |
          cd src/Client
          npm run lint --if-present

      - name: Build
        run: |
          cd src/Client
          npm run build --if-present

  docker_build_push:
    name: Build & Push Docker images
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create .env file for Docker
        run: |
          echo "ASPNETCORE_ENVIRONMENT=${{ secrets.ASPNETCORE_ENVIRONMENT }}" > .env.bank
          echo "ConnectionStrings__DefaultConnection=${{ secrets.DB_BANK_CONNECTION_STRING }}" >> .env.bank
          echo "RabbitMq__Host=${{ secrets.RABBIT_HOST }}" >> .env.bank
          echo "RabbitMq__Username=${{ secrets.RABBIT_USERNAME }}" >> .env.bank
          echo "RabbitMq__Password=${{ secrets.RABBIT_PASSWORD }}" >> .env.bank
          echo "RabbitMq__Port=${{ secrets.RABBIT_PORT }}" >> .env.bank

          echo "ASPNETCORE_ENVIRONMENT=${{ secrets.ASPNETCORE_ENVIRONMENT }}" > .env.transactions
          echo "ConnectionStrings__DefaultConnection=${{ secrets.DB_TRANSACTIONS_CONNECTION_STRING }}" >> .env.transactions
          echo "RabbitMq__Host=${{ secrets.RABBIT_HOST }}" >> .env.transactions
          echo "RabbitMq__Username=${{ secrets.RABBIT_USERNAME }}" >> .env.transactions
          echo "RabbitMq__Password=${{ secrets.RABBIT_PASSWORD }}" >> .env.transactions
          echo "RabbitMq__Port=${{ secrets.RABBIT_PORT }}" >> .env.transactions
          echo "BankApiUrl=${{ secrets.BANK_API_URL }}" >> .env.transactions

      - name: Docker Compose Build
        run: |
          docker compose build --pull

      - name: Docker Compose Push
        run: |
          docker compose push

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: [docker_build_push]
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}   
          key: ${{ secrets.SSH_KEY }}            
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e

            cd ${{ secrets.DEPLOY_PATH }}      

            if [ -d .git ]; then
              git pull
            fi

            docker compose pull
            docker compose up -d --remove-orphans

            docker image prune -f

            docker ps
